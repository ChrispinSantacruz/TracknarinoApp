# TracknariÃ±o Backend

Backend de la aplicaciÃ³n TracknariÃ±o, orientado a mejorar la eficiencia del transporte de carga en el departamento de NariÃ±o. Soporta funcionalidades como autenticaciÃ³n, creaciÃ³n y asignaciÃ³n de oportunidades logÃ­sticas, seguimiento en tiempo real, notificaciones y alertas de seguridad.

---

## ğŸ“¦ InstalaciÃ³n Paso a Paso

### ğŸ”§ 1. Clonar el repositorio o crear manualmente la carpeta
```bash
mkdir backend_tracknarino
cd backend_tracknarino
```

### ğŸ”§ 2. Inicializar el proyecto Node.js
```bash
npm init -y
```

### ğŸ”§ 3. Instalar dependencias necesarias
```bash
npm install express mongoose dotenv bcrypt jsonwebtoken cors axios firebase-admin haversine-distance
```

### ğŸ”§ 4. Instalar herramientas de desarrollo (hot reload)
```bash
npm install --save-dev nodemon
```

### ğŸ”§ 5. Crear la estructura del proyecto
```bash
mkdir controllers models routes services middleware config
```

### ğŸ”§ 6. Crear archivo principal
```bash
touch server.js
```

### ğŸ”§ 7. Crear archivo `.env`
```
PORT=4000
MONGO_URI=mongodb://localhost:27017/tracknarino
```

> AsegÃºrate de tener MongoDB instalado y corriendo localmente (recomendado MongoDB 8.0.8).

---

## ğŸ‘¥ Usuarios de prueba

### Camionero
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MDA2YzY4NTEzYjdmMDc1MmE3MDFjMCIsInRpcG8iOiJjYW1pb25lcm8iLCJpYXQiOjE3NDQ4NTkxNjUsImV4cCI6MTc0NDk0NTU2NX0.VxdlFbtnkPotbpEmwHdrcORgNwIpV3JjrhaGDlFuksw",
  "usuario": {
    "_id": "68006c68513b7f0752a701c0",
    "nombre": "Carlos Ruiz",
    "correo": "carlos@example.com",
    "tipoUsuario": "camionero"
  }
}
```

### Contratista
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MDA2ZGY2NTEzYjdmMDc1MmE3MDFjNSIsInRpcG8iOiJjb250cmF0aXN0YSIsImlhdCI6MTc0NDg1OTIwMiwiZXhwIjoxNzQ0OTQ1NjAyfQ.nFjZNIBwsiF-rcMPdIwk8mfyNaGeDfzirSjoXfmXzDM",
  "usuario": {
    "_id": "68006df6513b7f0752a701c5",
    "nombre": "Laura Contratista",
    "correo": "laura@empresa.com",
    "tipoUsuario": "contratista"
  }
}
```

---

## ğŸš€ EjecuciÃ³n del proyecto

### 1. Iniciar el servidor
```bash
npm start
```

> El servidor se ejecutarÃ¡ en: `http://localhost:4000`

### 2. Configurar Postman o Thunder Client
Para pruebas de rutas protegidas:
- Ir a la pestaÃ±a **Headers**
- Agregar:
```
Authorization: Bearer [tu_token_jwt]
```
Ejemplo:
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

## âœ… Funcionalidades principales

### ğŸ” AutenticaciÃ³n y roles
- Registro con tipo de usuario (camionero o contratista)
- Inicio de sesiÃ³n con JWT
- Middleware de protecciÃ³n por rol (`soloRol()`)

### ğŸš› GestiÃ³n de cargas
- Contratista crea oportunidad de transporte
- Camionero ve cargas disponibles
- Contratista asigna un camionero a una carga
- Contratista finaliza la carga

### ğŸ›°ï¸ Seguimiento GPS
- Camionero actualiza su ubicaciÃ³n en tiempo real
- Contratista consulta ubicaciÃ³n actual de su carga asignada

### ğŸ“² Notificaciones push
- Registro de `deviceToken` por usuario
- NotificaciÃ³n automÃ¡tica al asignar carga

### ğŸš¨ Alertas de seguridad
- CreaciÃ³n de alertas con ubicaciÃ³n y tipo (trancon, sospecha, robo, etc.)
- VisualizaciÃ³n de alertas recientes
- BÃºsqueda de alertas cercanas a coordenadas dadas (con radio)

### ğŸ§‘â€ğŸ’¼ Panel para contratistas
- Listado de todos los camioneros registrados

---

## ğŸ§ª GuÃ­a de pruebas con ejemplos

### ğŸ” Registro de usuario
**POST** `/api/auth/registro`
```json
{
  "nombre": "Juan PÃ©rez",
  "correo": "juan.perez@example.com",
  "contraseÃ±a": "password123",
  "tipoUsuario": "camionero",
  "telefono": "123456789",
  "empresaAfiliada": "Empresa X",
  "licenciaExpedicion": "2025-01-01",
  "numeroCedula": "123456789",
  "camion": {
    "tipoVehiculo": "camion de carga",
    "capacidadCarga": 1000,
    "marca": "Volvo",
    "modelo": "2020",
    "placa": "ABC123",
    "papelesAlDia": true
  }
}
```

### ğŸ” Inicio de sesiÃ³n
**POST** `/api/auth/login`
```json
{
  "correo": "juan.perez@example.com",
  "contraseÃ±a": "password123"
}
```

### ğŸ” Login
**POST** `/api/auth/login`
```json
{
  "correo": "carlos@example.com",
  "contraseÃ±a": "contrasenaSegura123"
}
```

### ğŸ“¦ Crear carga (contratista)
**POST** `/api/oportunidades/crear`
```json
{
  "titulo": "Carga refrigerada",
  "descripcion": "Alimentos perecederos",
  "origen": "Pasto",
  "destino": "Tumaco",
  "fecha": "2025-04-18T08:00:00Z",
  "precio": 850000
}
```

### ğŸ“¥ Asignar carga (contratista)
**POST** `/api/oportunidades/asignar/:id`
```json
{
  "camioneroId": "68006c68513b7f0752a701c0"
}
```

### ğŸ“ Reportar ubicaciÃ³n (camionero)
**POST** `/api/ubicacion/actualizar`
```json
{
  "lat": 1.2136,
  "lng": -77.2811
}
```

### ğŸ“ Ver ubicaciÃ³n (contratista)
**GET** `/api/ubicacion/ultima/:camioneroId`

### ğŸ“² Registrar token FCM
**POST** `/api/notificaciones/registrar-token`
```json
{
  "token": "fcm_token_123"
}
```

### ğŸš¨ Crear alerta de seguridad
**POST** `/api/alertas/crear`
```json
{
  "tipo": "sospecha",
  "descripcion": "Personas extraÃ±as en la curva",
  "coords": { "lat": 1.214, "lng": -77.280 }
}
```

### ğŸ” Ver alertas cercanas
**GET** `/api/alertas/cercanas?lat=1.214&lng=-77.280&radio=3000`

---

ğŸ‰ El backend TracknariÃ±o estÃ¡ 100% listo para ser consumido desde un frontend mÃ³vil o web. Puedes conectar con React Native, Flutter, o cualquier app que consuma APIs REST.



eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MDA2YzY4NTEzYjdmMDc1MmE3MDFjMCIsInRpcG8iOiJjYW1pb25lcm8iLCJpYXQiOjE3NDUyNzgwMjUsImV4cCI6MTc0NTM2NDQyNX0.lN0IhSDO1gN66SjxGwu82pOuP71l6x-m7Os14n8ybdo